<!DOCTYPE html>
<html>

<head>

<meta charset="utf-8">
<title>index</title>


<style type="text/css">
body {
  font-family: Helvetica, arial, sans-serif;
  font-size: 14px;
  line-height: 1.6;
  padding-top: 10px;
  padding-bottom: 10px;
  background-color: white;
  padding: 30px; }

body > *:first-child {
  margin-top: 0 !important; }
body > *:last-child {
  margin-bottom: 0 !important; }

a {
  color: #4183C4; }
a.absent {
  color: #cc0000; }
a.anchor {
  display: block;
  padding-left: 30px;
  margin-left: -30px;
  cursor: pointer;
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0; }

h1, h2, h3, h4, h5, h6 {
  margin: 20px 0 10px;
  padding: 0;
  font-weight: bold;
  -webkit-font-smoothing: antialiased;
  cursor: text;
  position: relative; }

h1:hover a.anchor, h2:hover a.anchor, h3:hover a.anchor, h4:hover a.anchor, h5:hover a.anchor, h6:hover a.anchor {
  background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA09pVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoMTMuMCAyMDEyMDMwNS5tLjQxNSAyMDEyLzAzLzA1OjIxOjAwOjAwKSAgKE1hY2ludG9zaCkiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OUM2NjlDQjI4ODBGMTFFMTg1ODlEODNERDJBRjUwQTQiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OUM2NjlDQjM4ODBGMTFFMTg1ODlEODNERDJBRjUwQTQiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo5QzY2OUNCMDg4MEYxMUUxODU4OUQ4M0REMkFGNTBBNCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo5QzY2OUNCMTg4MEYxMUUxODU4OUQ4M0REMkFGNTBBNCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PsQhXeAAAABfSURBVHjaYvz//z8DJYCRUgMYQAbAMBQIAvEqkBQWXI6sHqwHiwG70TTBxGaiWwjCTGgOUgJiF1J8wMRAIUA34B4Q76HUBelAfJYSA0CuMIEaRP8wGIkGMA54bgQIMACAmkXJi0hKJQAAAABJRU5ErkJggg==) no-repeat 10px center;
  text-decoration: none; }

h1 tt, h1 code {
  font-size: inherit; }

h2 tt, h2 code {
  font-size: inherit; }

h3 tt, h3 code {
  font-size: inherit; }

h4 tt, h4 code {
  font-size: inherit; }

h5 tt, h5 code {
  font-size: inherit; }

h6 tt, h6 code {
  font-size: inherit; }

h1 {
  font-size: 28px;
  color: black; }

h2 {
  font-size: 24px;
  border-bottom: 1px solid #cccccc;
  color: black; }

h3 {
  font-size: 18px; }

h4 {
  font-size: 16px; }

h5 {
  font-size: 14px; }

h6 {
  color: #777777;
  font-size: 14px; }

p, blockquote, ul, ol, dl, li, table, pre {
  margin: 15px 0; }

hr {
  background: transparent url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAYAAAAECAYAAACtBE5DAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OENDRjNBN0E2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OENDRjNBN0I2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo4Q0NGM0E3ODY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo4Q0NGM0E3OTY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PqqezsUAAAAfSURBVHjaYmRABcYwBiM2QSA4y4hNEKYDQxAEAAIMAHNGAzhkPOlYAAAAAElFTkSuQmCC) repeat-x 0 0;
  border: 0 none;
  color: #cccccc;
  height: 4px;
  padding: 0;
}

body > h2:first-child {
  margin-top: 0;
  padding-top: 0; }
body > h1:first-child {
  margin-top: 0;
  padding-top: 0; }
  body > h1:first-child + h2 {
    margin-top: 0;
    padding-top: 0; }
body > h3:first-child, body > h4:first-child, body > h5:first-child, body > h6:first-child {
  margin-top: 0;
  padding-top: 0; }

a:first-child h1, a:first-child h2, a:first-child h3, a:first-child h4, a:first-child h5, a:first-child h6 {
  margin-top: 0;
  padding-top: 0; }

h1 p, h2 p, h3 p, h4 p, h5 p, h6 p {
  margin-top: 0; }

li p.first {
  display: inline-block; }
li {
  margin: 0; }
ul, ol {
  padding-left: 30px; }

ul :first-child, ol :first-child {
  margin-top: 0; }

dl {
  padding: 0; }
  dl dt {
    font-size: 14px;
    font-weight: bold;
    font-style: italic;
    padding: 0;
    margin: 15px 0 5px; }
    dl dt:first-child {
      padding: 0; }
    dl dt > :first-child {
      margin-top: 0; }
    dl dt > :last-child {
      margin-bottom: 0; }
  dl dd {
    margin: 0 0 15px;
    padding: 0 15px; }
    dl dd > :first-child {
      margin-top: 0; }
    dl dd > :last-child {
      margin-bottom: 0; }

blockquote {
  border-left: 4px solid #dddddd;
  padding: 0 15px;
  color: #777777; }
  blockquote > :first-child {
    margin-top: 0; }
  blockquote > :last-child {
    margin-bottom: 0; }

table {
  padding: 0;border-collapse: collapse; }
  table tr {
    border-top: 1px solid #cccccc;
    background-color: white;
    margin: 0;
    padding: 0; }
    table tr:nth-child(2n) {
      background-color: #f8f8f8; }
    table tr th {
      font-weight: bold;
      border: 1px solid #cccccc;
      margin: 0;
      padding: 6px 13px; }
    table tr td {
      border: 1px solid #cccccc;
      margin: 0;
      padding: 6px 13px; }
    table tr th :first-child, table tr td :first-child {
      margin-top: 0; }
    table tr th :last-child, table tr td :last-child {
      margin-bottom: 0; }

img {
  max-width: 100%; }

span.frame {
  display: block;
  overflow: hidden; }
  span.frame > span {
    border: 1px solid #dddddd;
    display: block;
    float: left;
    overflow: hidden;
    margin: 13px 0 0;
    padding: 7px;
    width: auto; }
  span.frame span img {
    display: block;
    float: left; }
  span.frame span span {
    clear: both;
    color: #333333;
    display: block;
    padding: 5px 0 0; }
span.align-center {
  display: block;
  overflow: hidden;
  clear: both; }
  span.align-center > span {
    display: block;
    overflow: hidden;
    margin: 13px auto 0;
    text-align: center; }
  span.align-center span img {
    margin: 0 auto;
    text-align: center; }
span.align-right {
  display: block;
  overflow: hidden;
  clear: both; }
  span.align-right > span {
    display: block;
    overflow: hidden;
    margin: 13px 0 0;
    text-align: right; }
  span.align-right span img {
    margin: 0;
    text-align: right; }
span.float-left {
  display: block;
  margin-right: 13px;
  overflow: hidden;
  float: left; }
  span.float-left span {
    margin: 13px 0 0; }
span.float-right {
  display: block;
  margin-left: 13px;
  overflow: hidden;
  float: right; }
  span.float-right > span {
    display: block;
    overflow: hidden;
    margin: 13px auto 0;
    text-align: right; }

code, tt {
  margin: 0 2px;
  padding: 0 5px;
  white-space: nowrap;
  border: 1px solid #eaeaea;
  background-color: #f8f8f8;
  border-radius: 3px; }

pre code {
  margin: 0;
  padding: 0;
  white-space: pre;
  border: none;
  background: transparent; }

.highlight pre {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px; }

pre {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px; }
  pre code, pre tt {
    background-color: transparent;
    border: none; }

sup {
    font-size: 0.83em;
    vertical-align: super;
    line-height: 0;
}
* {
	-webkit-print-color-adjust: exact;
}
@media screen and (min-width: 914px) {
    body {
        width: 854px;
        margin:0 auto;
    }
}
@media print {
	table, pre {
		page-break-inside: avoid;
	}
	pre {
		word-wrap: break-word;
	}
}
</style>


</head>

<body>

<script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-57004739-1', 'auto');
      ga('send', 'pageview');
</script>

<p>This page contains the instructions and general information for my OSCON 2016 tutorial:<br>
<a href="http://conferences.oreilly.com/oscon/open-source-us/public/schedule/detail/49043">Don&#39;t fix it. Throw it away! Introduction to disposable infrastructure</a></p>

<p><a href="https://www.surveymonkey.com/r/ZKKYJHT">Please complete this survey after the course! Thanks!</a></p>

<ul>
<li><strong>Slides</strong>: <a href="2016-oscon-disposable.pptx">PPTX</a> <a href="2016-oscon-disposable.pdf">PDF</a></li>
<li>I plan to leave this site up after the course in case you want to use the tutorial again later.</li>
</ul>

<h2 id="toc_0">Prerequisites</h2>

<p>The following are the prerequisites for the course. PLEASE come to the course with all of this sorted out. Don&#39;t hesitate to contact me with questions. It&#39;s a short lesson, so we don&#39;t have time to spend playing IT admin.</p>

<h3 id="toc_1">Hardware</h3>

<p>Something to hack on. Preferably a laptop.</p>

<h3 id="toc_2">Operating System</h3>

<p>You are free to choose what you&#39;d like to run this software on. It will be much easier for both of us if you&#39;re on OS X or Linux though, as I haven&#39;t touched Windows in years. If you&#39;re using a VM, make sure it can reach the Internet. Note that I&#39;ll be doing the tutorial on a Mac.</p>

<h3 id="toc_3">Software</h3>

<hr>

<p>If you&#39;re on the OSCON Wifi, you can download these from the local OSCON server: <a href="http://172.16.0.20/oscon/DorrosChris/">http://172.16.0.20/oscon/DorrosChris/</a>. For the Vagrant box add, you can run this:</p>

<div><pre><code class="language-none">    vagrant box add ubuntu/trusty64 \
    http://172.16.0.20/oscon/DorrosChris/trusty-server-cloudimg-amd64-vagrant-disk1.box</code></pre></div>

<hr>

<p>Install the latest version of this software:</p>

<ul>
<li><a href="https://www.vagrantup.com/downloads.html">Vagrant</a></li>
<li><a href="https://www.terraform.io/downloads.html">Terraform</a></li>
<li><a href="https://www.packer.io/downloads.html">Packer</a></li>
</ul>

<p>If you&#39;re on a Mac, note that most of these are available via &#39;brew&#39;:</p>

<div><pre><code class="language-none">brew cask install virtualbox
brew cask install vagrant
brew install packer
brew install terraform</code></pre></div>

<p>Install the Ubuntu Trusty 64 box. <strong>This one is important to do before the session</strong>, as it&#39;s a large OS image file, and we don&#39;t want to overload the conference WiFi. (DoS Techniques is a different course number)
<code>vagrant box add ubuntu/trusty64</code></p>

<p>We&#39;ll use Puppet during the tutorial, but it isn&#39;t necessary to install this on your laptop as the HashiCorp tools support this.</p>

<h3 id="toc_4">Accounts</h3>

<ul>
<li><p><strong>Active AWS account</strong></p>

<ul>
<li><strong>This is probably the most important pre-req!</strong> It&#39;s the most time consuming of all the setup.</li>
<li>You can setup a fresh account - take a look at the Free Tier (https://aws.amazon.com/free/). We will try to spin up resources in AWS that are covered under the Free Tier - I can&#39;t guarantee there will be no costs associated with the activity, though (would be very minimal if there is)</li>
<li>If you&#39;re reusing an existing account, that&#39;s fine, but just note that there may be some extra setup in the beginning for you. Also note that <strong>you&#39;re at your own risk</strong> with whichever account you decide to use, so you may want to create a fresh account just for the tutorial.</li>
<li>Ensure your user account has privilege to create / manage AWS services (in IAM-&gt;Users-&gt;youruser-&gt;Permissions-&gt;Attach Policy-&gt;Administrator Access)</li>
<li><strong>IAM &quot;access key ID&quot; and &quot;secret access key&quot; for your user</strong>
(Getting Your Access Key ID and Secret Access Key)</li>
</ul></li>
<li><p><strong>github.com</strong> (optional but recommended)</p></li>
</ul>

<h2 id="toc_5">0. Get Setup</h2>

<ol>
<li>Ensure you have setup all the required tools and AWS pieces in the Prerequisites section</li>
<li>Install the Ubuntu Trusty 64-bit Vagrant box:<br>
<code>vagrant box add ubuntu/trusty64</code></li>
<li>Checkout <a href="https://github.com/cdorros/oscon2016">this github repo</a> to a place of your choosing. From here on we will refer to this path as [gh_repo].</li>
<li>Upload your SSH key to AWS. In the GUI this is under EC2-&gt;Key Pairs. Note the name of the SSH key in AWS.</li>
<li>Edit the terraform/variables.tf file to add the name of your SSH key, replacing &quot;your-key-name&quot;
<em>Now We&#39;ll setup the networking components of AWS required for the tutorial (VPC, subnets, routing, etc). Don&#39;t worry so much about the Terraform commands at this point - we&#39;ll cover Terraform in more detail in section 3.</em></li>
<li><code>cd terraform</code><br></li>
<li>Set AWS credentials into environment variables
<code>export AWS_ACCESS_KEY_ID=&#39;youraccesskeyid&#39;</code>
<code>export AWS_SECRET_ACCESS_KEY=&#39;yoursecretkey&#39;</code></li>
<li><code>terraform plan</code></li>
<li><code>terraform apply</code>
If this fails due to IP CIDR conflict, navigate in the GUI to &quot;VPC-&gt;Your VPC&quot; and &quot;VPC-&gt;Subnets&quot; and look for a free RFC-1918 range (172.16.0.0/12, 10.0.0.0/8, 192.168.0.0/16). Make sure the subnet is actually a subnet of the VPC range (in my config I&#39;m using 10.0.0.0/16 for the VPC and 10.0.1.0/24 and 10.0.2.0/24 as the two subnets.</li>
<li><strong>Note down the VPC and Subnet IDs outputted at the end, we&#39;ll need these later</strong></li>
</ol>

<p><strong><em>STOP HERE! We&#39;ll cover sections 1-4 during the tutorial.</em></strong></p>

<h2 id="toc_6">1. Vagrant App</h2>

<p>In this step we are going to spin up a new Vagrant box, using Ubuntu 14.04, and deploy a web server (nginx) via Puppet.</p>

<ol>
<li>Start in the base directory, [gh_repo]</li>
<li>Create a new vagrant instance<br>
<code>vagrant init ubuntu/trusty64</code></li>
<li>Open the Vagrantfile, and uncomment this line:
<code>config.vm.network &quot;forwarded_port&quot;, guest: 80, host: 8080</code></li>
<li>Start the virtual machine and SSH in<br>
<code>vagrant up &amp;&amp; vagrant ssh</code></li>
<li><code>exit</code> out of the SSH session</li>
<li><p>Open the Vagrantfile and add the Puppet provisioning steps:</p>

<div><pre><code class="language-none">config.vm.provision &quot;puppet&quot; do |puppet|
  puppet.manifests_path = &quot;puppet/manifests&quot;
  puppet.manifest_file = &quot;app.pp&quot;
  puppet.module_path = &quot;puppet/modules&quot;
end</code></pre></div></li>
<li><p>Apply the Puppet module<br>
<code>vagrant destroy &amp;&amp; vagrant up</code>
<code>Are you sure you want to destroy the &#39;default&#39; VM? [y/N] y</code></p></li>
<li><p>From outside VM: <code>curl localhost:8080</code><br>
You should see the default nginx page</p></li>
<li><p>Done! Let&#39;s tear down the Vagrant instance for now<br>
<code>vagrant destroy</code></p></li>
</ol>

<h2 id="toc_7">2. Packer</h2>

<ol>
<li><code>cd [gh_repo]/packer</code></li>
<li>Open &quot;variables.json&quot; and add the values for aws_vpc_id and aws_subnet_id that we saved during the setup. For the subnet ID you can pick either one here, it&#39;s just where the AMI will be built.</li>
<li><p>Set AWS credentials into environment variables (if not already done)
<code>export AWS_ACCESS_KEY_ID=&#39;youraccesskeyid&#39;</code>
<code>export AWS_SECRET_ACCESS_KEY=&#39;yoursecretkey&#39;</code></p>

<p>If you&#39;re using Windows, you can add these directly to the variables.tf file <a href="https://www.terraform.io/docs/providers/aws/index.html">see example here</a>. <strong>Be careful though</strong>, you don&#39;t want to check this into source control!</p></li>
<li><p>Let&#39;s test out our AWS setup by building a plain Ubuntu 14.04 AMI
<code>packer validate -var-file=variables.json app.json</code>
<code>packer build -var-file=variables.json app.json</code><br>
This should spit out an AMI ID at the end if successful.</p></li>
<li><p>Now we tell Packer to apply our Puppet config during build.<br>
Add the following to variables.json: (mind the commas)
<code>&quot;puppet_manifest_file&quot;: &quot;../puppet/manifests/app.pp&quot;</code></p></li>
<li><p>Update the contents of the app.json file to look like the code below. Notice we added the &quot;provisioners&quot; block.</p>

<div><pre><code class="language-none">{
  &quot;builders&quot;: [
    {
      &quot;type&quot;: &quot;amazon-ebs&quot;,
      &quot;region&quot;: &quot;{{user `aws_region`}}&quot;,
      &quot;vpc_id&quot;: &quot;{{user `aws_vpc_id`}}&quot;,
      &quot;subnet_id&quot;: &quot;{{user `aws_subnet_id`}}&quot;,
      &quot;source_ami&quot;: &quot;{{user `ubuntu_1404_ami`}}&quot;,
      &quot;instance_type&quot;: &quot;{{user `aws_instance_type`}}&quot;,
      &quot;ssh_username&quot;: &quot;{{user `aws_ssh_username`}}&quot;,
      &quot;ami_name&quot;: &quot;{{user `ami_prefix`}}-{{timestamp}}&quot;,
      &quot;iam_instance_profile&quot;: &quot;{{user `iam_instance_profile`}}&quot;
    }
  ],
  &quot;provisioners&quot;: [
    {
      &quot;type&quot;: &quot;shell&quot;,
      &quot;inline&quot;: [
        &quot;sleep 10&quot;,
        &quot;sudo apt-get update&quot;,
        &quot;sudo apt-get install -y puppet&quot;
      ]
    },
    {
      &quot;type&quot;: &quot;puppet-masterless&quot;,
      &quot;manifest_file&quot;: &quot;{{user `puppet_manifest_file`}}&quot;,
      &quot;module_paths&quot;: [
        &quot;../puppet/modules&quot;
      ]
    }
  ]
}</code></pre></div></li>
<li><p>Build a new AMI image
<code>packer validate -var-file=variables.json app.json</code>
<code>packer build -var-file=variables.json app.json</code><br>
This will spit out an AMI ID at the end (ami-xxxxxxxx). <strong>Save this! Note down that it&#39;s the &quot;default nginx image&quot;</strong></p></li>
</ol>

<h2 id="toc_8">3. Terraform</h2>

<ol>
<li><code>$ cd [gh_repo]/terraform</code></li>
<li>Set AWS credentials into environment variables (if not already done)
<code>export AWS_ACCESS_KEY_ID=&#39;youraccesskeyid&#39;</code>
<code>export AWS_SECRET_ACCESS_KEY=&#39;yoursecretkey&#39;</code></li>
<li><p>Copy over the infrastructure files:</p>

<div><pre><code class="language-none">cp 3/* .</code></pre></div></li>
<li><p>Open the &quot;ec2_instances.tf&quot; file and update the ami for the &quot;app-1&quot; instance to the AMI ID you saved during the last Packer build.</p></li>
<li><p>Run Terraform in NOOP mode
<code>terraform plan</code></p></li>
<li><p>Build our infrastructure!
<code>terraform apply</code></p></li>
<li><p>Once the Terraform run in complete, note the public IP of the app-1 instance outputted. (this can also be found in the terraform.tfstate file or the EC2 section of the AWS GUI)</p></li>
<li><p>After waiting a few minutes for the instance to boot up (you&#39;ll get connection refused until it&#39;s finished):<br>
<code>curl [public_ip]</code></p></li>
<li><p>Note down the DNS name of the ELB (elastic load balancer) (elb_fqdn) in the Terraform output</p></li>
<li><p>This should return no content, since we haven&#39;t added the instance behind the load balancer yet:
<code>curl [dns_name]</code><br>
Note that <code>curl -v</code> would show a 503 (service unavailable) response. Also note you may get a DNS resolution error until the new record is propogated.</p></li>
<li><p>Add the instance to the ELB by editing &quot;elb.tf&quot;. In the &quot;instances&quot; array, add: <code>&quot;${aws_instance.app-1.id}&quot;</code></p></li>
<li><p>Apply our changes
<code>terraform plan</code>,
<code>terraform apply</code></p></li>
<li><p>Try curling the ELB again. Note that it will take some time for this to work, as the instance needs to be healthy for a set period before the load balancer will direct traffic to it. (you could run this under the <code>watch</code> command if you have that installed)<br>
<code>curl [dns_name]</code></p></li>
</ol>

<h2 id="toc_9">4. Making Changes!</h2>

<p>Our website is pretty boring. Let&#39;s change the content up. We&#39;ll now get to exercise the entire deployment workflow we&#39;ve just built!  </p>

<ol>
<li><code>cd [gh_repo]/puppet/modules/app/manifests</code><br></li>
<li><p>Create a new file to hold our web server config named &quot;config.pp&quot; with the following content  </p>

<div><pre><code class="language-none"># config for our OSCON demo app
#
class app::config {

  file { &quot;/etc/nginx/sites-available/default&quot;:
    source =&gt; &quot;puppet:///modules/${module_name}/default-proxy&quot;,
    mode =&gt; &quot;0644&quot;,
    owner =&gt; &quot;root&quot;,
    group =&gt; &quot;root&quot;,
    ensure =&gt; present,
    notify =&gt; Service[&#39;nginx&#39;],
    ;
  } 
}</code></pre></div></li>
<li><p>Add the new config to the &quot;init.pp&quot; file<br>
<code>include app::config</code></p></li>
<li><p>Note that the new configuration is already in the Puppet directory, we just weren&#39;t using it. To see it:
<code>cat ../files/default-proxy</code></p></li>
<li><p>Test out the changes locally in Vagrant:  </p>

<div><pre><code class="language-none">cd [gh_repo] #(base)
vagrant up
curl localhost:8080</code></pre></div>

<p>You should see a weather forecast for Austin, TX</p></li>
<li><p>Bulid a new AMI using Packer:</p>

<div><pre><code class="language-none">cd packer
packer validate -var-file=variables.json app.json
packer build -var-file=variables.json app.json</code></pre></div>

<p><strong>Save the AMI ID! Note down that it&#39;s the &quot;weather app image&quot;</strong></p></li>
<li><p><code>cd ../terraform</code></p></li>
<li><p>Create a new instance in the Terraform &quot;ec2_instance.tf&quot; config by copy/pasta the app-1 block to an app-2 block (including the &quot;output&quot;). Bump the version number too. Use the new AMI ID for this one.</p></li>
<li><p>Spin up the new app version instance
<code>terraform plan</code>
<code>terraform apply</code></p></li>
<li><p>Grab the public IP address of your new instance from the tfstate file or the GUI, and curl it to ensure it&#39;s functioning properly</p></li>
<li><p>Add the new instance to the ELB (elb.tf, instances array)</p></li>
<li><p>Open a new terminal to watch the ELB, if you don&#39;t already have one open
<code>watch curl [elb_dns_name]</code></p></li>
<li><p><code>terraform plan</code>, <code>terraform apply</code> (you know the drill)</p></li>
<li><p>In the curl/watch window, you should see some switching of responses, based on which instance the ELB forwarded your request to. (keepalives, HTTP/2, DNS, and some other technicalities can make this quite variable, so don&#39;t worry so much if you don&#39;t see much exciting here)</p></li>
<li><p>Remove the old (app-1) instance from the ELB (elb.tf)</p></li>
<li><p><code>terraform plan</code>, <code>terraform apply</code></p></li>
<li><p>Eventually your curl/watch window should ONLY be showing the new, weather app (may take a few minutes). Note the the weather app doesn&#39;t display nicely underneath &quot;watch&quot; - run a regular curl to see it in all its glory.</p></li>
</ol>

<p>UPGRADE DONE! Notice that we didn&#39;t touch any existing production instance to make this change. We didn&#39;t even SSH into an EC2 instance once during this whole upgrade!</p>

<p>If you want to cleanup everything we created in Terraform during the tutorial, just run <code>terraform destroy</code></p>




</body>

</html>
